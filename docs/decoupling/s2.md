Project Backlog: Sprint 2 - Decoupling e57writer_lib
Introduction

Following the successful decoupling of the E57 parser in Sprint 1, this sprint continues the architectural refactoring initiative outlined in the Product Requirements Document (PRD). The focus of Sprint 2 is to isolate the E57 file writing logic by creating an abstraction layer for the e57writer_lib component. This will further enhance the system's modularity, making the E57 writing process independent of the components that trigger it, such as the main application or data processing modules.
User Stories

    User Story 2: Decouple the E57 Writer

        As a developer, I want to abstract the E57 file writing functionality behind an interface so that I can easily test data export features without creating actual files and allow for future extensions, such as supporting different writer libraries or output formats.

        Description: This user story focuses on creating an IE57Writer interface that defines a contract for all E57 writing operations. The existing E57WriterLib class will be refactored to implement this interface. Components that currently use E57WriterLib directly will be modified to depend on the new abstraction, using dependency injection to receive a concrete writer instance. This will break the hard-coded dependency and improve the overall design by adhering to the Dependency Inversion Principle.

Actions to Undertake

To complete User Story 2, the following actions must be taken:

    Define IE57Writer Interface:

        Analyze the public API of src/e57writer_lib.h to identify all methods required for creating and writing E57 files.

        Create a new header file, src/IE57Writer.h, to define the abstract base class.

        Declare pure virtual functions for all public writer operations. Key methods will include createFile, addScan, definePointPrototype, writePoints, closeFile, and getLastError. The interface should accommodate the various overloads and data structures (like ScanMetadata and Point3D) used by the writer.

        Include a virtual destructor in the interface to ensure correct polymorphic destruction.

    Refactor E57WriterLib:

        Modify the E57WriterLib class declaration in src/e57writer_lib.h to publicly inherit from IE57Writer.

        Update the method signatures in E57WriterLib to use the override keyword, ensuring they match the interface definition.

        Verify that the existing implementation of E57WriterLib correctly fulfills the new interface contract.

    Update Consuming Components:

        Identify all parts of the application that instantiate or call E57WriterLib. This will likely include MainWindow and potentially other data management classes responsible for export functionality.

        Refactor these consuming classes to depend on the IE57Writer interface via a pointer or reference, removing any direct #include of e57writer_lib.h.

        Update the application's composition root (likely in main.cpp or a factory class) to inject the concrete E57WriterLib instance into the components that require it.

References between Files

    src/IE57Writer.h (New File):

        Will be included by src/e57writer_lib.h for implementation.

        Will be included by any class that needs to write E57 files (e.g., src/mainwindow.h), replacing the direct inclusion of e57writer_lib.h.

        Will be included by test files, such as tests/test_e57writer_lib.cpp, for testing through the interface.

    src/e57writer_lib.h (Modified):

        Will now #include "IE57Writer.h".

        The E57WriterLib class declaration will be changed to class E57WriterLib : public IE57Writer.

    Consuming Classes (e.g., src/mainwindow.cpp) (Modified):

        Will be refactored to remove the direct dependency on E57WriterLib. They will hold a pointer to IE57Writer and interact with it through the defined interface.

    tests/test_e57writer_lib.cpp (Modified):

        Tests will be updated to verify the functionality of E57WriterLib through the IE57Writer interface, ensuring the abstraction works as expected.

List of Files being Created

    File 1: src/IE57Writer.h

        Purpose: To define a stable, abstract contract for E57 file writing operations. This decouples the rest of the application from the specific implementation details of libE57Format.

        Contents:

            Declaration of the IE57Writer abstract class.

            Forward declarations for necessary structs like ScanMetadata and Point3D.

            Pure virtual functions for the writer's public API, for example:

                virtual bool createFile(const QString& filePath) = 0;

                virtual bool addScan(const ScanMetadata& metadata) = 0;

                virtual bool writePoints(const std::vector<Point3D>& points, const ExportOptions& options) = 0;

                virtual bool closeFile() = 0;

                virtual QString getLastError() const = 0;

            A virtual destructor: virtual ~IE57Writer() = default;.

        Relationships: Implemented by E57WriterLib. Consumed by MainWindow and other components responsible for data export.

Acceptance Criteria

    A new header file, src/IE57Writer.h, exists and defines a pure abstract interface for all E57 writing operations.

    The E57WriterLib class correctly implements the IE57Writer interface.

    Any component that previously used E57WriterLib directly is refactored to use the IE57Writer interface.

    The application compiles successfully, and all features related to exporting or saving E57 files function as they did before the refactoring.

    The writePoints and addScan methods, with their various overloads and struct parameters, are correctly represented in the interface.

    Unit tests for e57writer_lib are updated to test functionality through the new interface.

Testing Plan

    Test Case 1: Unit Test Regression for E57WriterLib

        Description: Ensure that the E57WriterLib class, after implementing the IE57Writer interface, still passes all its existing unit tests.

        Test Data: The existing test suite in tests/test_e57writer_lib.cpp will be used.

        Expected Result: All tests should pass, confirming that the refactoring did not introduce regressions in the writer's core logic.

        Testing Tool: Google Test.
    Test Case 2: Interface Polymorphism Test

        Description: Create a test case that instantiates E57WriterLib but interacts with it solely through an IE57Writer pointer to verify that the abstraction is complete and functional.

        Test Data: A small, programmatically generated set of points and metadata.

        Expected Result: A valid E57 file should be created successfully, proving that the interface correctly exposes all necessary functionality.

        Testing Tool: Google Test.
    Test Case 3: Mock Writer Integration Test

        Description: Develop a mock implementation of IE57Writer that simulates file creation and writing operations without actually touching the disk (e.g., it could write to an in-memory buffer or simply log method calls). Inject this mock into MainWindow to test the application's export-triggering logic.

        Test Data: N/A (the mock will simulate success/failure).

        Expected Result: When an export action is triggered in the UI, the corresponding methods on the mock writer (e.g., createFile, writePoints) are called with the correct parameters. This validates that the UI is correctly wired to the abstraction.

        Testing Tool: Google Test with a manually created mock IE57Writer class.

Assumptions and Dependencies

    Assumptions:

        The existing public methods of E57WriterLib are sufficient for all current and near-future E57 writing needs of the application.

        The logic within e57writer_lib.cpp is functionally sound and does not require significant changes beyond implementing the interface.

    Dependencies:

        Sprint 1: This sprint assumes that the e57parserlib has been successfully decoupled, as some components might interact with both interfaces.

        libE57Format: The underlying third-party writing library.

        Qt Framework: For QString, QVector3D, QQuaternion, and other data types used in the E57WriterLib API.

Non-Functional Requirements

    Performance: The performance impact of using virtual functions for the writer interface must be measured. Given that file I/O is the primary bottleneck in writing operations, the overhead should be negligible. Benchmarks will compare file-writing times before and after the refactoring to ensure no significant performance degradation (target: < 2% overhead).

    Code Clarity: The separation of the interface (IE57Writer.h) from the implementation (e57writer_lib.h/.cpp) must result in cleaner, more readable code in consumer classes like MainWindow, which will now have a simpler dependency.

Conclusion

By the end of Sprint 2, the e57writer_lib component will be fully decoupled from the rest of the application, mirroring the work done on the parser in Sprint 1. This will significantly improve the design of our data export features, making them more testable and easier to maintain. This sprint moves the project closer to its goal of a fully modular architecture based on SOLID principles.